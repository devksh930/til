# 다양한 연관관계 매핑

## 다대일

- 다대일 관계의 반대방향은 항상 일대다 관계이고 일대다의 반대 방향은 항상 다대일 관계이다.
- 테이블의 일(1), 다(N)관계에서 외래 키는 항상 다쪽에 있다.
- 객체의 양방향 관계에서 연관관계의 주인은 항상 다 쪽이다.
    - 예를 들어 회원(N),팀(1) 이 있으면 회원이 연관관계의 주인이다.

### 다대일 단방향[N:1]

![다대일 단방향](https://user-images.githubusercontent.com/45715241/115025593-84175180-9efc-11eb-81a9-5ae5bf75bda8.png)

- 회원은 Member.team으로 팀 엔티티를 참조할 수 있지만 반대로 팀에는 회원을 참조하는 필드가 없다. 따라서 회원과 팀은 다대일 단방향 연관관계

```java
@ManyToOne
@JoinColumn(name = "TEAM_ID")
private Team team;
```

- `@JoinColumn(name = "Team_ID")`을 사용해서 `Member.team` 필드로 회원 테이블의 `TEAM_ID`외래키를 관리한다.

### 다대일 양방향

![ORM06-1](https://user-images.githubusercontent.com/45715241/115125339-70561300-a002-11eb-80a8-0ca5ea74b446.png)

- 연관관계의 주인은 Member.team이고 Team.members는 연관관계의 주인이 아니다.

`양방향은 외래 키가 있는 쪽이 연관관계의 주인이다.`

- 일대다와 다대일 연관관계는 항상 다(N)에 외래키가 존재한다.
    - 여기서는 다(N)쪽인 MEMBER테이블이 외래키를 가지고 있으므로 Member.team이 연관관계의 주인이다.
- JPA는 외래키를 관리할때 연관관계의 주인만 사용한다.
    - 주인이 아닌 Team.members는 조회를 위한 JPQL이나 객체 그래프를 탐색할 때 사용한다.

`양방향 연관관계는 항상 서로를 참조해야한다.`

- 양방향 연관관계는 항상 서로 참조해야한다. 어느 한쪽만 참조하면 양방향 연관관계가 성립하지 않는다.

## 일대다

- 일대다 관계는 다대일 관계의 반대 방향이다.
- 일대다 관계는 엔티티를 하나 이상 참조할 수 있으므로 자바 컬렉션인 `Collection`, `List`, `Set`, `Map` 중에 하나를 사용해야 한다.

### 일대다 단방향[1:N]

![JPA-2019-09-01-1](https://user-images.githubusercontent.com/45715241/115125751-35a1aa00-a005-11eb-835e-5ea8b1c2ae81.png)

- 하나의 팀은 여러 회원을 참조할 수 있는데 이런 관계를 일대다 관계라 한다.
- 팀은 회원들을 참조하지만 반대로 회원은 팀을 참조하지 않으면 둘의 관계는 단방향이다.(1:N 단방향 관계는 JPA2.0부터 지원)
- Team.members로 회원 테이블의 TEAM_ID 외래키를 관리한다.
    - 보통 자신이 매핑한 테이블의 외래 키를 관리하는데 이 매핑은 반대쪽 테이블에 있는 외래키를 관리한다.

`일대다 단반향 매핑의 단점`

- 단반향 매핑의 단점은 매핑한 객체가 관리하는 외래키가 다른테이블에 있다.
- 본인테이블에 외래 키가 있으면 엔티티의 저장과 연관관계 처리르 `INSERTE SQL` 한번으로 처리가 가능하지만 다른테이블에 외래키가 존재하면 연관관계 처리를 위한 추가적인 `UPADATE SQL` 이
  필요하다.

## 일대다 양방향

- 일대다 양방향 매핑은 존재하지 않는다. 대신 다대일 양방향 매핑을 사용한다.
    - 양방향 매핑에서 `@OneToMany`는 연관관계의 주인이 될수 없다. 다대일 관계는 항상 다쪽에 외래 키가 있다. 따라서 `@OneToMany`, `@ManyToOne` 둘중에 연관관계의 주인은 항상 다
      쪽인 `@ManyToOne`을 사용한 곳이다.
- 일대다 단방향 매핑 반대편에 다대일 단방향 매핑을 추가한다. 이때 일대다 단방향 매핑과 같은 `TEAM_ID` 외래 키 컬럼을 매핑한다. 이렇게 되면 둘다 같은 키를 관리하므로 문제가 발생할 수 있다. 따라서
  반대편인 다대일 쪽은 `
  `insertable= false, updatable = false`로 설정해서 읽기만 가능하게 매핑한다.
- 해당 방법은 일대다 양방향 매핑이라기 보다는 일대다 단방향 매핑 반대편에 다대일 단방향 매핑을 읽기전용으로 추가해서 일대 다 양방향 처럼 보이게 하는 방법이다.
  `일대다 단방향 매핑이 가지는 단점을 그대로 가지므로 될수있으면 다대일 양방향 매핑을 이용하는 것이 좋다`
